@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.i18n.Messages
@import play.api.mvc.Call
@import play.api.data.Form
@import play.twirl.api.Html
@import play.api.mvc.Request
@import uk.gov.hmrc.hmrcfrontend.views.html.helpers.HmrcStandardPage
@import uk.gov.hmrc.hmrcfrontend.views.html.components.HmrcHeader
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukSelect
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukHint
@import uk.gov.hmrc.govukfrontend.views.viewmodels.select.Select
@import uk.gov.hmrc.govukfrontend.views.viewmodels.hint.Hint
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.Text
@import uk.gov.hmrc.govukfrontend.views.html.components.FullWidthPageLayout
@import uk.gov.hmrc.cdsreimbursementclaimstubs.controllers.routes
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.hmrcstandardpage.HmrcStandardPageParams
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.hmrcstandardpage.TemplateOverrides

@this(head: Head, hmrcStandardPage: HmrcStandardPage, fullWidthPageLayout: FullWidthPageLayout, oneThirdOneThirdMainContent: OneThirdOneThirdMainContent, hmrcHeader: HmrcHeader, govukSelect: GovukSelect, govukHint: GovukHint)

@(responseTypeSelect: Select, mrnSelect: Select, gbSelect: Select, xiSelect: Select, rfsSelect: Select)(implicit request: Request[_], messages: Messages)

@sidebar = {
<pre>
    <code style="width: fit-content;" class="language-json" id="code-area">
           {
             message: "Waiting for response..."
           }
    </code>
</pre>
}

@hmrcStandardPage(HmrcStandardPageParams(
    pageTitle = Some("Generate MRN"),
    templateOverrides = TemplateOverrides(
        additionalHeadBlock = Some(head()),
        pageLayout = Some(fullWidthPageLayout(_)),
        mainContentLayout = Some(oneThirdOneThirdMainContent(sidebarContent = sidebar))
    ))) {

<h1 class="govuk-heading-xl govuk-!-margin-bottom-6">Generate MRN</h1>

<h2 class="govuk-heading-l govuk-!-margin-bottom-2">MRN Number</h2>
@govukHint(Hint(content = Text("Select if this is the first mrn, second mrn, or so - Character 1st and 2nd")))
@govukSelect(mrnSelect)

<h2 class="govuk-heading-l govuk-!-margin-bottom-2">Response Type</h2>
@govukHint(Hint(content = Text("Select the type of response your expect back - Character 4th and 5th")))
@govukSelect(responseTypeSelect)

<h2 class="govuk-heading-l govuk-!-margin-bottom-2">EORI</h2>
@govukHint(Hint(content = Text("The last two characters of the MRN determine the EORI produced, if it is 50 or above then it is XI Eori - Character 17th and 18th")))
<div style="display: flex;" class="govuk-radios" data-module="govuk-radios">
    <div class="govuk-radios__item">
        <input class="govuk-radios__input" id="gb-type" name="gb-or-xi" type="radio" value="gb" onclick="handleGbPicked()">
        <label class="govuk-label govuk-radios__label" for="gb-type">
            GB
        </label>
    </div>
    <div class="govuk-radios__item">
        <input class="govuk-radios__input" id="xi-type" name="gb-or-xi" type="radio" value="xi" onclick="handleXiPicked()">
        <label class="govuk-label govuk-radios__label" for="xi-type">
            XI
        </label>
    </div>
</div>
<div style="display:flex; align-items: center;">
    <h3 class="govuk-heading-s govuk-!-margin-right-2" id="eori-show">GB00000000000000</h3>
    <button class="govuk-button" onclick="copyEORI()">Copy</button>
</div>
@govukSelect(xiSelect)
@govukSelect(gbSelect)

<div class="govuk-checkboxes__item">
    <input class="govuk-checkboxes__input" id="security" name="security" type="checkbox" value="security" onclick="handleSecurityCheckbox()">
    <label class="govuk-label govuk-checkboxes__label" for="security">
        Need reason for security
    </label>
</div>
<div style="display: none;" id="reason-for-security-area">
<h2 class="govuk-heading-l govuk-!-margin-bottom-2">Reason For Security</h2>
@govukHint(Hint(content = Text("If the reason for security can be inserted then we add it to the response or else it is ignored - Character 6th, 7th and 8th")))
@govukSelect(rfsSelect)
</div>


<h2 class="govuk-heading-l govuk-!-margin-bottom-2">Output MRN</h2>
@govukHint(Hint(content = Text("MRN that you will need to use to get the expected output")))
<div style="display:flex;">
    <h1 class="govuk-heading-l govuk-!-margin-bottom-2 govuk-!-margin-right-2" id="mrn-output">00AMRACSAAAAAAAA00</h1>
    <button class="govuk-button" onclick="copyMRN()">Copy</button>
</div>
<style>
 .select-margin {
  margin-right: 5px;
 }
</style>
<script>
 const url = "@routes.DeclarationController.getDeclaration";

 const handleGbPicked = () => {
    document.getElementById("gb-picker").style.display = "block";
    document.getElementById("xi-picker").style.display = "none";
    handleEoriChange();
 }

 const handleXiPicked = () => {
    document.getElementById("gb-picker").style.display = "none";
    document.getElementById("xi-picker").style.display = "block";
    handleEoriChange();
 }

 const handleEoriChange = () => {
    const eoriEnding = getEoriEnding();
    document.getElementById("eori-show").innerHTML = `${parseInt(eoriEnding) < 50 ? "GB" : "XI"}000000000000${eoriEnding}`
    handleMrnChange()
 }

 const handleSecurityCheckbox = () => {
    const sec = document.getElementById("security")
      if(sec.checked) {
          document.getElementById("reason-for-security-area").style.display = "block"
      } else {
          document.getElementById("reason-for-security-area").style.display = "none"
      }
    handleMrnChange()
 }

 const getMrnNumber = () => document.getElementById("mrn-picker").value

 const getResponseType = () => document.getElementById("response-type-selector").value

 const getReasonForSecurity = () => document.getElementById("security").checked ? document.getElementById("rfs-selector").value : "AAA"

 const getEoriEnding = () => {
    var eoriEnding  = "";
      if(document.getElementById("gb-type").checked){
        const gbValue = document.getElementById("gb-picker").value
        eoriEnding = document.getElementById("gb-picker").value
        document.getElementById("eori-show").innerHTML = `GB000000000000${gbValue}`
      }

     if(document.getElementById("xi-type").checked){
      const xiValue = document.getElementById("xi-picker").value
      eoriEnding = document.getElementById("xi-picker").value
      document.getElementById("eori-show").innerHTML = `XI000000000000${xiValue}`
     }
     return eoriEnding;
 }

 const getMrnOutput = () => `${getMrnNumber()}A${getResponseType()}${getReasonForSecurity()}AAAAAAAA${getEoriEnding()}`

 const handleMrnChange = () => {
    const mrn = getMrnOutput()
    document.getElementById("mrn-output").innerHTML = mrn
    handleSubmit(url, mrn)
 }

 function copyMRN() {
    navigator.clipboard.writeText(document.getElementById("mrn-output").innerHTML);
 }

 function copyEORI() {
    navigator.clipboard.writeText(document.getElementById("eori-show").innerHTML);
 }

 function handleSubmit(url, mrn) {
   const body = {
    "overpaymentDeclarationDisplayRequest": {
        "requestCommon": {
            "originatingSystem": "MDTP",
            "receiptDate": "2023-04-21T07:35:39Z",
            "acknowledgementReference": "9474bdf1df434462b1cd911ddf64a3d5"
        },
        "requestDetail": {
            "declarationId": `${mrn}`
        }
    }
   };

   const data = {
    method: "POST",
    body: JSON.stringify(body),
    headers: {
    "Content-type": "application/json; charset=UTF-8"
    }
   }

   fetch(url, data)
    .then(res => res.json())
    .then(output => {
      document.getElementById("code-area").innerHTML = JSON.stringify(output, null, 4)
    })
    .catch(err => {
      document.getElementById("code-area").innerHTML = `           {
             message: "Failed to get response..."
           }`
    })
 }
 document.getElementById("gb-type").checked = true;
 document.getElementById("xi-picker").style.display = "none";
 handleMrnChange()


</script>

}
